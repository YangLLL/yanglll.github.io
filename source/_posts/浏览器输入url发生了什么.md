---
title: 浏览器输入url发生了什么?
date: 2021-05-27 11:00:57
tags:
---

浏览器中输入一个 url 到页面展示的主要流程分为下面几个阶段：
1. 构建请求
2. 查找浏览器缓存
3. DNS 解析
4. 建立 TCP 连接
5. 发起 HTTP 请求
6. 响应请求
7. 断开连接
8. 页面渲染

### 1. 构建请求
解析url，构建请求行

### 2. 查找浏览器缓存
缓存是一种保存资源副本并在下次请求时直接使用该副本的技术。  
浏览器在请求之前会查找本地是否有缓存，如果有缓存就用缓存的资源，如果没有再请求。  
浏览器的缓存策略分为强缓存和协商缓存。  
#### 强缓存 
- Catch-Control: max-age 设置过期时间，是一个时间段，HTTP1.1使用
- Expires：设置过期时间，设置的是一个时刻，HTTP1.0中使用。如果浏览器的时间和服务器的时间区别很大，缓存命中的判断就可能有问题
#### 协商缓存
- **If-None-Match 和 ETag**  
浏览器在向服务端请求资源时，响应头会返回一个ETag，浏览器再次向服务器请求资源的时候，request header 中会带上If-None-Match，值为上次请求服务器返回的ETag值，服务器拿到 ETag值后，和资源文件的ETag值做比较，如果ETag值相同，说明资源没有变化，命中协商缓存。

- **Last-Modified 和 If-Modified-Since**  
Last-Modified是资源文件最后一次修改的时间，会在response header中返回的，浏览器会将这个值保存起来，放到request header中的If-Modified-Since里，服务器在接收到后，会和Last-Modified做比较，如果相同，则命中协商缓存。

#### 浏览器缓存过程:
1. 浏览器第一次请求资源，没有缓存，向服务器发送请求，服务器返回200，浏览器将请求到的资源文件和响应头，和请求时间一并缓存起来。
2. 再次请求资源时，将本次请求和上次请求的时间差和Cache-Control的max-age做对比，如果没有超过max-age的时间，则没有过期，命中强缓存，直接从浏览器缓存中获取资源。HTTP1.0 通过Expires来判断是否过期。如果时间过期了，请求头带上If-None-Match 和 If-Modified-Since 向服务器请求。
3. 服务器收到请求后，将 If-None-Match 带的 ETag，和资源文件的 ETag进行对比，如果相同，说明上次请求后资源没有更新，命中协商缓存，返回304，浏览器从缓存中读取资源。如果ETag不同，服务器处理请求，返回新的资源文件，response header中返回新的ETag，返回状态码 200
4. 如果服务器接收到的请求没有 ETag，则将If-Modified-Since 和资源文件的最近更新时间对比，如果 If-Modified-Since 的时间比上次更新的时间晚，则命中协商缓存，返回304。否则，返回新的资源文件，response header中返回新的 Last-Modified，返回状态码 200

参考：https://www.cnblogs.com/suihang/p/12855345.html


### 3. DNS 解析
DNS服务器中有一个域名IP对照表，可以返回域名对应的 IP

### 4. 建立 TCP 连接
获取到IP地址和端口号之后，不会马上建立连接。Chrome有个机制，同一个域名同时最多只能建立 6 个连接，如果超过了 6 个，就要进入排队等待，直到进行中的请求完成。
排队结束后，客户端和服务器通过三次握手建立 TCP 连接。
首先 客服端向服务端发送一个消息，服务器接收到消息，表示客户端发送消息的能力没问题，服务端接收能力没问题。然后服务端向客服端回一个消息，客户端收到消息，表示服务端发送消息的能力没问题，客户端接收数据的能力也没问题。这样，客户端和服务端之间就可以传输数据了

### 5. 发起 HTTP 请求
建立连接之后，客服端就可以向服务端发送请求了。
HTTP请求报文，是由请求行，请求头、空行和请求体组成。

### 6. 响应请求
服务器接收到请求后，进行处理，将对应的资源返回给客户端。
响应报文是由状态行，响应头，空行和响应体组成

- 响应状态码

### 7. 断开连接
数据发送完了之后，通过 “四次挥手” 断开连接。
首先是客服端往服务端发送一个消息，要断开连接了，然后服务端回复可以断开连接了，客户端发送断开连接的消息给服务端，并断开了客户端的连接，服务器收到之后也断开了服务端的连接

### 8. 页面渲染
浏览器获取到资源后，就要进行页面渲染。页面渲染分为以下几个阶段

- DOM解析
 将 html 解析成dom 树
- CSS 解析
然后解析CSS，生成 css规则树
- render
结合 DOM 树和 CSSOM 树，构建render树
- layout
然后进行布局
- paint
最后绘制到页面上
- 回流（reflow）、重绘（repaint）

- JavaScript编译执行


### 其他
#### 登录状态是如何保存的 cookie
